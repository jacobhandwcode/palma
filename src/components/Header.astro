---
import LanguageSwitcher from './LanguageSwitcher.astro';
import { useTranslations, getLocalizedUrl } from '../i18n/utils';

interface Props {
  currentLang?: 'en' | 'es' | 'pt';
}

const { currentLang = 'en' } = Astro.props;
const t = useTranslations(currentLang);

function extractCurrentPath(pathname: string, lang: string) {
  let path = pathname.replace(/^\/+/, '');

  if (path.startsWith(`${lang}/`)) {
    path = path.replace(`${lang}/`, '');
  }

  path = path.replace(/\/+$/, '');
  const segments = path.split('/');

  return segments[0] || '';
}

const currentPath = extractCurrentPath(Astro.url.pathname, currentLang);

const backgroundPages = [
  'team',
  'gallery',
  'press',
  'terms-use',
  'privacy-policy',
];
const hasInitialBackground = backgroundPages.includes(currentPath);
---

<header
  class={hasInitialBackground ? 'has-initial-background' : ''}
  id="header"
>
  <div class="header-wrapper">
    <div class="hamburger" id="hamburger">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <a href={getLocalizedUrl(currentLang, '')} class="logo">
      <img
        src="/images/icons/palma-logo.svg"
        alt="Palma Miami Beach Logo"
        height="70px"
        width="100%"
      />
    </a>
    <div class="nav-right">
      <LanguageSwitcher currentLang={currentLang} currentPath={currentPath} />
      <a href="tel:13059464264" class="phone-number">+1 305.946.4264</a>
      <a class="inquire" href="#contact">{t('nav.inquire')}</a>
    </div>
  </div>

  <div class="mobile-menu-overlay" id="mobileMenu">
    <div class="menu-reveal-block"></div>

    <div class="mobile-menu-content">
      <div class="menu-left">
        <nav class="mobile-nav">
          <a
            href={getLocalizedUrl(currentLang, '')}
            class={`mobile-nav-item ${currentPath === '' ? 'active' : ''}`}
            data-hover-image="/images/nav-home.webp"
          >
            {t('nav.home').toUpperCase()}
          </a>
          <a
            href={getLocalizedUrl(currentLang, 'amenities')}
            class={`mobile-nav-item ${currentPath === 'amenities' ? 'active' : ''}`}
            data-hover-image="/images/home/amenities.webp"
          >
            {t('nav.amenities').toUpperCase()}
          </a>
          <a
            href={getLocalizedUrl(currentLang, 'residences')}
            class={`mobile-nav-item ${currentPath === 'residences' ? 'active' : ''}`}
            data-hover-image="/images/residences/b1-living.webp"
          >
            {t('nav.residences').toUpperCase()}
          </a>
          <a
            href={getLocalizedUrl(currentLang, 'neighborhood')}
            class={`mobile-nav-item ${currentPath === 'neighborhood' ? 'active' : ''}`}
            data-hover-image="/images/home/neighborhood.webp"
          >
            {t('nav.neighborhood').toUpperCase()}
          </a>
          <a
            href={getLocalizedUrl(currentLang, 'team')}
            class={`mobile-nav-item ${currentPath === 'team' ? 'active' : ''}`}
            data-hover-image="/images/nav-team.webp"
          >
            {t('nav.team').toUpperCase()}
          </a>
          <a
            href={getLocalizedUrl(currentLang, 'gallery')}
            class={`mobile-nav-item ${currentPath === 'gallery' ? 'active' : ''}`}
            data-hover-image="/images/nav-gallery.webp"
          >
            {t('nav.gallery').toUpperCase()}
          </a>
          <a
            href={getLocalizedUrl(currentLang, 'press')}
            class={`mobile-nav-item ${currentPath === 'press' ? 'active' : ''}`}
            data-hover-image="/images/home/golden-girl.webp"
          >
            {t('nav.press').toUpperCase()}
          </a>
        </nav>
        <div class="mobile-menu-footer">
          <a
            id="instagram"
            href="https://www.instagram.com/palmamiamibeach/"
            target="_blank"
            class="social-link"
          >
            <img src="/images/icons/instagram.svg" />
          </a>
        </div>
      </div>
      <div class="menu-right">
        <div class="menu-image">
          <img src="/images/nav.webp" alt="Palma Building" id="menuImage" />
        </div>
      </div>
    </div>
  </div>
</header>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const hamburger = document.getElementById('hamburger');
    const mobileMenu = document.getElementById('mobileMenu');
    const menuImage = document.getElementById('menuImage');
    const navItems = document.querySelectorAll('.mobile-nav-item');
    const menuFooter = document.querySelector('.mobile-menu-footer');
    const menuImageContainer = document.querySelector('.menu-image');
    const header = document.getElementById('header');
    const baseImageSrc = '/images/nav.webp';

    let isTransitioning = false;
    let isMenuOpen = false;
    let lastHoveredImage = baseImageSrc;

    function handleScroll() {
      if (!header) return;

      const scrollTop =
        window.pageYOffset || document.documentElement.scrollTop;
      const scrollThreshold = 100;

      if (scrollTop > scrollThreshold) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }
    }

    window.addEventListener('scroll', handleScroll);

    function changeImageWithTransition(newImageSrc) {
      if (!menuImage || isTransitioning) {
        return;
      }

      const currentSrc = menuImage.src.split('/').pop();
      const newSrc = newImageSrc.split('/').pop();
      if (currentSrc === newSrc) {
        return;
      }

      isTransitioning = true;

      const newImg = new Image();

      newImg.onload = function () {
        menuImage.classList.add('fade-out');

        setTimeout(() => {
          menuImage.src = newImageSrc;
          menuImage.classList.remove('fade-out');

          setTimeout(() => {
            isTransitioning = false;
          }, 400);
        }, 400);
      };

      newImg.onerror = function () {
        console.warn('Failed to load image:', newImageSrc);
        menuImage.src = newImageSrc;
        isTransitioning = false;
      };

      newImg.src = newImageSrc;
    }

    function openMenu() {
      isMenuOpen = true;
      hamburger.classList.add('active');
      mobileMenu.classList.add('active');
      document.body.style.overflow = 'hidden';

      navItems.forEach((item) => {
        item.classList.remove('animate-out');
        item.classList.add('animate-in');
      });

      if (menuFooter) {
        menuFooter.classList.remove('animate-out');
        menuFooter.classList.add('animate-in');
      }

      if (menuImageContainer) {
        menuImageContainer.classList.remove('animate-out');
        menuImageContainer.classList.add('animate-in');
      }

      if (menuImage && menuImage.src !== baseImageSrc) {
        changeImageWithTransition(baseImageSrc);
        lastHoveredImage = baseImageSrc;
      }
    }

    function closeMenu() {
      isMenuOpen = false;
      hamburger.classList.remove('active');
      document.body.style.overflow = '';

      navItems.forEach((item) => {
        item.classList.remove('animate-in');
        item.classList.add('animate-out');
      });

      if (menuFooter) {
        menuFooter.classList.remove('animate-in');
        menuFooter.classList.add('animate-out');
      }

      if (menuImageContainer) {
        menuImageContainer.classList.remove('animate-in');
        menuImageContainer.classList.add('animate-out');
      }

      setTimeout(() => {
        mobileMenu.classList.remove('active');
      }, 800);

      setTimeout(() => {
        navItems.forEach((item) => {
          item.classList.remove('animate-out');
        });

        if (menuFooter) {
          menuFooter.classList.remove('animate-out');
        }

        if (menuImageContainer) {
          menuImageContainer.classList.remove('animate-out');
        }
      }, 1100);
    }

    if (hamburger && mobileMenu) {
      hamburger.addEventListener('click', function () {
        if (isMenuOpen) {
          closeMenu();
        } else {
          openMenu();
        }
      });

      navItems.forEach((item) => {
        item.addEventListener('mouseenter', function () {
          if (!isMenuOpen) return;

          const hoverImage = this.getAttribute('data-hover-image');
          if (hoverImage) {
            lastHoveredImage = hoverImage;
            changeImageWithTransition(hoverImage);
          }
        });

        item.addEventListener('mouseleave', function () {
          if (!isMenuOpen) return;
        });

        item.addEventListener('click', function () {
          closeMenu();
        });
      });

      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && isMenuOpen) {
          closeMenu();
        }
      });
    }

    window.addEventListener('beforeunload', function () {
      window.removeEventListener('scroll', handleScroll);
    });
  });
</script>
