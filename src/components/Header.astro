---
import LanguageSwitcher from './LanguageSwitcher.astro';
import { useTranslations, getLocalizedUrl } from '../i18n/utils';

interface Props {
  currentLang?: 'en' | 'es' | 'pt';
}

const { currentLang = 'en' } = Astro.props;
const t = useTranslations(currentLang);

const currentPath =
  Astro.url.pathname.replace(`/${currentLang}`, '').replace(/^\//, '') || '';
---

<header>
  <div class="header-wrapper">
    <div class="hamburger" id="hamburger">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <a href={getLocalizedUrl(currentLang, '')} class="logo">
      <img
        src="/images/icons/palma-logo.svg"
        alt="Palma Miami Beach Logo"
        height="70px"
        width="100%"
      />
    </a>
    <div class="nav-right">
      <LanguageSwitcher currentLang={currentLang} currentPath={currentPath} />
      <a href="tel:13059464264" class="phone-number">+1 305.946.4264</a>
      <a class="inquire" href="#contact">{t('nav.inquire')}</a>
    </div>
  </div>

  <div class="mobile-menu-overlay" id="mobileMenu">
    <div class="menu-reveal-block"></div>

    <div class="mobile-menu-content">
      <div class="menu-left">
        <nav class="mobile-nav">
          <a
            href={getLocalizedUrl(currentLang, '')}
            class={`mobile-nav-item ${currentPath === '' ? 'active' : ''}`}
            data-hover-image="/images/nav-home.webp"
          >
            {t('nav.home').toUpperCase()}
          </a>
          <a
            href={getLocalizedUrl(currentLang, 'amenities')}
            class={`mobile-nav-item ${currentPath === 'amenities' ? 'active' : ''}`}
            data-hover-image="/images/home/amenities.webp"
          >
            {t('nav.amenities').toUpperCase()}
          </a>
          <a
            href={getLocalizedUrl(currentLang, 'residences')}
            class={`mobile-nav-item ${currentPath === 'residences' ? 'active' : ''}`}
            data-hover-image="/images/residences/b1-living.webp"
          >
            {t('nav.residences').toUpperCase()}
          </a>
          <a
            href={getLocalizedUrl(currentLang, 'neighborhood')}
            class={`mobile-nav-item ${currentPath === 'neighborhood' ? 'active' : ''}`}
            data-hover-image="/images/home/neighborhood.webp"
          >
            {t('nav.neighborhood').toUpperCase()}
          </a>
          <a
            href={getLocalizedUrl(currentLang, 'team')}
            class={`mobile-nav-item ${currentPath === 'team' ? 'active' : ''}`}
            data-hover-image="/images/nav-team.webp"
          >
            {t('nav.team').toUpperCase()}
          </a>
          <a
            href={getLocalizedUrl(currentLang, 'gallery')}
            class={`mobile-nav-item ${currentPath === 'gallery' ? 'active' : ''}`}
            data-hover-image="/images/nav-gallery.webp"
          >
            {t('nav.gallery').toUpperCase()}
          </a>
          <a
            href={getLocalizedUrl(currentLang, 'press')}
            class={`mobile-nav-item ${currentPath === 'press' ? 'active' : ''}`}
            data-hover-image="/images/home/golden-girl.webp"
          >
            {t('nav.press').toUpperCase()}
          </a>
        </nav>
        <div class="mobile-menu-footer">
          <a
            href="https://www.instagram.com/palmamiamibeach/"
            target="_blank"
            class="social-link"
          >
            <img src="/images/icons/instagram.svg" />
          </a>
        </div>
      </div>
      <div class="menu-right">
        <div class="menu-image">
          <img src="/images/nav.webp" alt="Palma Building" id="menuImage" />
        </div>
      </div>
    </div>
  </div>
</header>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const hamburger = document.getElementById('hamburger');
    const mobileMenu = document.getElementById('mobileMenu');
    const menuImage = document.getElementById('menuImage');
    const navItems = document.querySelectorAll('.mobile-nav-item');
    const baseImageSrc = '/images/nav.webp';

    let isTransitioning = false;

    function changeImageWithTransition(newImageSrc) {
      if (!menuImage || isTransitioning) {
        return;
      }

      const currentSrc = menuImage.src.split('/').pop();
      const newSrc = newImageSrc.split('/').pop();
      if (currentSrc === newSrc) {
        return;
      }

      isTransitioning = true;

      const newImg = new Image();

      newImg.onload = function () {
        menuImage.classList.add('fade-out');

        setTimeout(() => {
          menuImage.src = newImageSrc;
          menuImage.classList.remove('fade-out');

          setTimeout(() => {
            isTransitioning = false;
          }, 400);
        }, 400);
      };

      newImg.onerror = function () {
        console.warn('Failed to load image:', newImageSrc);
        menuImage.src = newImageSrc;
        isTransitioning = false;
      };

      newImg.src = newImageSrc;
    }

    if (hamburger && mobileMenu) {
      hamburger.addEventListener('click', function () {
        hamburger.classList.toggle('active');
        mobileMenu.classList.toggle('active');

        if (mobileMenu.classList.contains('active')) {
          document.body.style.overflow = 'hidden';
          if (menuImage && menuImage.src !== baseImageSrc) {
            changeImageWithTransition(baseImageSrc);
          }
        } else {
          document.body.style.overflow = '';
        }
      });

      navItems.forEach((item) => {
        item.addEventListener('mouseenter', function () {
          const hoverImage = this.getAttribute('data-hover-image');
          console.log('Hovering on:', this.textContent, 'Image:', hoverImage);
          if (hoverImage) {
            changeImageWithTransition(hoverImage);
          }
        });

        item.addEventListener('mouseleave', function () {
          console.log('Mouse left:', this.textContent);
          changeImageWithTransition(baseImageSrc);
        });

        item.addEventListener('click', function () {
          hamburger.classList.remove('active');
          mobileMenu.classList.remove('active');
          document.body.style.overflow = '';
        });
      });

      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && mobileMenu.classList.contains('active')) {
          hamburger.classList.remove('active');
          mobileMenu.classList.remove('active');
          document.body.style.overflow = '';
        }
      });
    }
  });
</script>
