---
import {
  getLangFromUrl,
  useTranslations,
  getLocalizedUrl,
} from '../i18n/utils';
import Disclaimers from './Disclaimers.astro';

interface Props {
  lang?: 'en' | 'es' | 'pt';
}

const { lang } = Astro.props;
const currentLang = lang || getLangFromUrl(Astro.url);
const t = useTranslations(currentLang);
---

<footer id="contact">
  <h3>
    {t('footer.tagline')}
  </h3>
  <img
    src="/images/icons/palma-logo.svg"
    alt="Palma Miami Beach"
    class="footer-logo"
  />

  <form class="contact-form" id="contactForm">
    <div class="form-row">
      <div class="form-group">
        <input
          placeholder={t('form.firstName.placeholder')}
          type="text"
          id="firstName"
          name="firstName"
          required
        />
        <label for="firstName">{t('form.firstName.label')}*</label>
      </div>
      <div class="form-group">
        <input
          placeholder={t('form.lastName.placeholder')}
          type="text"
          id="lastName"
          name="lastName"
          required
        />
        <label for="lastName">{t('form.lastName.label')}*</label>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <input
          placeholder={t('form.email.placeholder')}
          type="email"
          id="email"
          name="email"
          required
        />
        <label for="email">{t('form.email.label')}*</label>
      </div>
      <div class="form-group">
        <input
          placeholder={t('form.phone.placeholder')}
          type="tel"
          id="phone"
          name="phone"
        />
        <label for="phone">{t('form.phone.label')}</label>
      </div>
      <div class="form-group">
        <select id="hearAbout" name="hearAbout">
          <option value="">{t('form.hearAbout.label')}</option>
          <option value="area-driveby">{t('form.hearAbout.driveby')}</option>
          <option value="gale-south-beach-loyalty-guest"
            >{t('form.hearAbout.gale')}</option
          >
          <option value="broker">{t('form.hearAbout.broker')}</option>
          <option value="event">{t('form.hearAbout.event')}</option>
          <option value="google-organic"
            >{t('form.hearAbout.googleOrganic')}</option
          >
          <option value="direct">{t('form.hearAbout.direct')}</option>
          <option value="google-keywords"
            >{t('form.hearAbout.googleKeywords')}</option
          >
          <option value="real-estate-site"
            >{t('form.hearAbout.realEstate')}</option
          >
          <option value="social-media">{t('form.hearAbout.socialMedia')}</option
          >
          <option value="internet-ad">{t('form.hearAbout.internetAd')}</option>
          <option value="internet-search"
            >{t('form.hearAbout.internetSearch')}</option
          >
          <option value="magazine">{t('form.hearAbout.magazine')}</option>
          <option value="newspaper">{t('form.hearAbout.newspaper')}</option>
          <option value="referral">{t('form.hearAbout.referral')}</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <textarea
        placeholder={t('form.comments.placeholder')}
        id="comments"
        name="comments"
        rows="4"></textarea>
      <label for="comments">{t('form.comments.label')}</label>
    </div>

    <div class="form-row radio-row">
      <div class="radio-group">
        <span class="radio-label">
          {t('form.realtor.question')}
          <span class="required">*</span>
        </span>
        <div class="radio-options">
          <label class="radio-option">
            <input type="radio" name="realtor" value="yes" />
            <span class="radio-custom"></span>
            {t('form.yes')}
          </label>
          <label class="radio-option">
            <input type="radio" name="realtor" value="no" checked />
            <span class="radio-custom"></span>
            {t('form.no')}
          </label>
        </div>
      </div>

      <div class="radio-group">
        <span class="radio-label">
          {t('form.buyerBroker.question')}
          <span class="required">*</span>
        </span>
        <div class="radio-options">
          <label class="radio-option">
            <input type="radio" name="buyerBroker" value="buyer" />
            <span class="radio-custom"></span>
            {t('form.buyer')}
          </label>
          <label class="radio-option">
            <input type="radio" name="buyerBroker" value="broker" checked />
            <span class="radio-custom"></span>
            {t('form.broker')}
          </label>
        </div>
      </div>
    </div>

    <!-- Cloudflare Turnstile Integration -->
    <div class="form-group full-width" style="display: none;">
      <div class="cf-turnstile" data-sitekey="0x4AAAAAABr_qHsmHh66T10c"></div>
    </div>

    <div class="terms-section">
      <p class="terms-text">
        {t('form.terms.intro')}
        <a href={getLocalizedUrl(currentLang, 'privacy-policy')}
          >{t('form.terms.privacyPolicy')}</a
        >.
        <span class="required">*</span>
      </p>
      <label class="checkbox-option">
        <input type="checkbox" name="terms" required />
        <span class="checkbox-custom"></span>
        {t('form.terms.agreement')}
      </label>
    </div>

    <button type="submit" class="submit-btn">{t('form.submit')}</button>
  </form>

  <div class="footer-info">
    <div class="contact-info">
      <h4>{t('footer.inquire')}</h4>
      <p>Info@PalmaMiamiBeach.com</p>
      <p>{t('footer.telephone')} +1 305.946.4264</p>

      <h4>{t('footer.projectAddress')}</h4>
      <p>600 71st Street, Miami Beach, FL 33141</p>

      <h4>{t('footer.salesGallery')}</h4>
      <p class="italic">580 72nd Street, Retail D, Miami Beach, FL 33141</p>
    </div>

    <div class="company-logos">
      <img
        src="/images/icons/lefferts-logo.svg"
        alt="Lefferts"
        class="lefferts-logo"
      />
      <img
        src="/images/icons/cervera-logo.svg"
        alt="Cervera Real Estate"
        class="cervera-logo"
      />
    </div>

    <div class="footer-bottom">
      <p class="copyright">
        {t('footer.copyright')}
      </p>

      <div class="footer-links">
        <a href={getLocalizedUrl(currentLang, 'privacy-policy')}
          >{t('footer.links.privacy')}</a
        >
        <span>|</span>
        <a href={getLocalizedUrl(currentLang, 'notices-terms')}
          >{t('footer.links.notices')}</a
        >
        <span>|</span>
        <button
          type="button"
          class="disclaimers-link"
          data-disclaimers
          aria-label={t('disclaimers.title')}
        >
          {t('footer.links.disclaimers')}
        </button>
      </div>
    </div>
  </div>
</footer>

<Disclaimers lang={currentLang} />

<!-- Load Cloudflare Turnstile -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<script>
  (function (w, i, d, g, e, t) {
    w['WidgetTrackerObject'] = g;
    (w[g] =
      w[g] ||
      function () {
        (w[g].q = w[g].q || []).push(arguments);
      }),
      (w[g].ds = 1 * new Date());
    (e = 'script'),
      (t = d.createElement(e)),
      (e = d.getElementsByTagName(e)[0]);
    t.async = 1;
    t.src = i;
    e.parentNode.insertBefore(t, e);
  })(window, 'https://widgetbe.com/agent', document, 'widgetTracker');
  window.widgetTracker('create', 'WT-JKXYEMIJ');
  window.widgetTracker('send', 'pageview');
</script>

<script>
  document
    .getElementById('contactForm')
    .addEventListener('submit', async function (e) {
      e.preventDefault();
      e.stopPropagation();

      const submitBtn = this.querySelector('.submit-btn');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Sending...';
      submitBtn.disabled = true;
      submitBtn.style.opacity = '0.7';

      const formData = new FormData(this);
      const data = Object.fromEntries(formData);

      // Check required fields
      if (!data.firstName || !data.lastName || !data.email) {
        alert('Please fill in all required fields.');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        return;
      }

      if (!data.terms) {
        alert('Please accept the terms and privacy policy.');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        return;
      }

      // Check Turnstile verification
      const turnstileResponse = document.querySelector('[name="cf-turnstile-response"]')?.value;
      if (!turnstileResponse) {
        alert('Please complete the security verification.');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        return;
      }

      // Add Turnstile response to data
      data['cf-turnstile-response'] = turnstileResponse;

      try {
        const response = await fetch('/form-handler.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });

        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const textResponse = await response.text();
          console.error('Non-JSON response:', textResponse);
          throw new Error(
            'Server returned non-JSON response: ' +
              textResponse.substring(0, 100)
          );
        }

        const result = await response.json();

        if (response.ok && result.success) {
          const footer = document.getElementById('contact');
          footer.innerHTML = `
        <div class="success-message-container">
          <h3 class="success-title">Thank You!</h3>
          <p class="success-message">${result.message}</p>
        </div>
      `;

          if (window.widgetTracker) {
            window.widgetTracker('send', 'event', 'form', 'submit', 'contact');
          }
        } else {
          const errorMessage = result.error || 'Unknown error occurred';
          alert('Error: ' + errorMessage);

          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
          submitBtn.style.opacity = '1';
        }
      } catch (error) {
        console.error('Form submission error:', error);

        let errorMessage = 'There was an error submitting your inquiry. ';

        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          errorMessage += 'Please check your internet connection.';
        } else if (error.message.includes('JSON')) {
          errorMessage += 'Server response format error.';
        } else if (error.message.includes('non-JSON')) {
          errorMessage += 'Server configuration issue.';
        } else {
          errorMessage += 'Please try again later or contact us directly.';
        }

        alert(errorMessage);

        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
      }
    });
</script>

<style>
  /* Add styles for Turnstile container */
  .cf-turnstile {
    margin: 20px 0;
    display: flex;
    justify-content: center;
  }

  .form-group.full-width {
    grid-column: 1 / -1;
  }

  /* Ensure the Turnstile widget is properly styled */
  .cf-turnstile iframe {
    border-radius: 8px;
  }
</style>