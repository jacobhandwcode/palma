---
import { getLangFromUrl, useTranslations } from '../i18n/utils';

interface Props {
  lang?: 'en' | 'es' | 'pt';
}

const { lang } = Astro.props;
const currentLang = lang || getLangFromUrl(Astro.url);
const t = useTranslations(currentLang);

const titleText = t('hero.title');
const titleLetters = titleText.split('').map((char, index) => ({
  char: char === ' ' ? '\u00A0' : char,
  isSpace: char === ' ',
  delay: index * 0.02,
}));

const titleAnimationDuration = titleLetters.length * 0.02 + 0.4;
const subtitleDelay = titleAnimationDuration;
const arrowDelay = subtitleDelay + 0.4;
---

<section class="hero">
  <div class="hero-video">
    <div class="video-placeholder"></div>
    <video autoplay muted loop playsinline>
      <source src="/videos/home-video.mp4" type="video/mp4" />
      {t('hero.video.fallback')}
    </video>
  </div>

  <div class="hero-content">
    <div class="hero-text">
      <h1 class="hero-title">
        <span class="desktop-title">
          {
            titleLetters.map((letter) => (
              <span
                class={`letter ${letter.isSpace ? 'space' : ''}`}
                style={`animation-delay: ${letter.delay}s`}
              >
                {letter.char}
              </span>
            ))
          }
        </span>
        <span class="mobile-title">
          {titleText}
        </span>
      </h1>
      <p
        class="hero-subtitle hero-subtitle-animated"
        style={`animation-delay: ${subtitleDelay}s`}
      >
        {t('hero.subtitle')}
      </p>
    </div>

    <div class="arrow arrow-animated" style={`animation-delay: ${arrowDelay}s`}>
      <a href="#palma" class="down-arrow"></a>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const video = document.querySelector(
      '.hero-video video'
    ) as HTMLVideoElement;
    const placeholder = document.querySelector(
      '.video-placeholder'
    ) as HTMLElement;

    if (video && placeholder) {
      
      const hidePlaceholder = () => {
        placeholder.style.opacity = '0';
        setTimeout(() => {
          placeholder.style.display = 'none';
        }, 500);
      };

      video.addEventListener('canplay', hidePlaceholder);

      if (video.readyState >= 3) {
        hidePlaceholder();
      }
      
      setTimeout(() => {
        if (placeholder.style.opacity !== '0') {
          hidePlaceholder();
        }
      }, 3000);
    }
  });
</script>

<style>
  .hero-video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
  }

  .video-placeholder {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('/images/video-placeholder.webp');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    opacity: 1;
    transition: opacity 0.5s ease-in-out;
    z-index: 3;
  }

  .hero-video video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    z-index: 2;
  }

  .hero-subtitle-animated {
    opacity: 0;
    transform: translateY(30px);
    animation: fadeUp 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
  }

  .arrow-animated {
    opacity: 0;
    transform: translate(-50%, 30px);
    margin: 0 auto;
    width: 0;
    animation: arrowFadeUp 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
  }

  .down-arrow {
    display: inline-block;
    cursor: pointer;
    animation: bounce 3s infinite ease-in-out;
  }

  .down-arrow::after {
    content: '';
    display: block;
    width: 20px;
    height: 20px;
    border: solid #ffffff;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
  }

  @keyframes bounce {
    0%,
    20%,
    50%,
    80%,
    100% {
      transform: translateY(0);
    }
    40% {
      transform: translateY(-15px);
    }
    60% {
      transform: translateY(-8px);
    }
  }

  .hero-title {
    overflow: hidden;
  }

  .mobile-title {
    display: none;
  }

  .desktop-title {
    display: block;
  }

  .desktop-title .letter {
    display: inline-block;
    opacity: 0;
    transform: translateY(30px);
    animation: letterFadeIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
  }

  .desktop-title .letter.space {
    width: 0.3em;
  }

  @keyframes letterFadeIn {
    0% {
      opacity: 0;
      transform: translateY(30px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeUp {
    0% {
      opacity: 0;
      transform: translateY(30px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes arrowFadeUp {
    0% {
      opacity: 0;
      transform: translate(-50%, 30px);
    }
    100% {
      opacity: 1;
      transform: translate(-50%, 0%);
    }
  }

  @media (max-width: 875px) {
    .desktop-title {
      display: none;
    }

    .mobile-title {
      display: block;
      opacity: 0;
      transform: translateY(30px);
      animation: fadeUp 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }

    .hero-subtitle-animated {
      animation-delay: 0.2s !important;
    }

    .arrow-animated {
      animation-delay: 0.4s !important;
    }
  }

  @media (max-width: 650px) {
    .arrow-animated {
      display: none;
    }
  }
</style>