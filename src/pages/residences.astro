---
import Layout from '../layouts/Layout.astro';
import PageHero from '../components/PageHero.astro';
import FloorPlans from '../components/FloorPlans.astro';
import { useTranslations } from '../i18n/utils';

const lang = 'en';
const t = useTranslations(lang);
---

<Layout
  title={t('residences.meta.title')}
  description={t('residences.meta.description')}
  lang={lang}
>
  <PageHero
    videoSrc="/videos/residences-video.mp4"
    title={t('residences.title')}
    lang={lang}
  />
  <section class="text-box no-bg">
    <p>
      {t('residences.intro.start')}
      <span>Palma</span>
      {t('residences.intro.middle')}
      <span>Palma</span>
      {t('residences.intro.end')}
    </p>
  </section>
  <section class="overlapped-image-section">
    <div class="background-image">
      <img
        src="/images/residences/residence-collage.webp"
        alt={t('residences.collage.alt')}
      />
    </div>
    <div class="overlay-image">
      <img
        src="/images/residences/love-life.png"
        alt={t('residences.overlay.alt')}
      />
    </div>
  </section>
  <section class="img-txt left has-gallery">
    <div class="img-txt-content">
      <div class="content-wrapper">
        <h2>{t('residences.features.title')}</h2>
        <ul>
          <li>{t('residences.features.beachLuxe')}</li>
          <li>{t('residences.features.furnished')}</li>
          <li>{t('residences.features.views')}</li>
          <li>{t('residences.features.balconies')}</li>
          <li>{t('residences.features.ceilings')}</li>
          <li>{t('residences.features.doors')}</li>
          <li>{t('residences.features.smart')}</li>
          <li>{t('residences.features.internet')}</li>
          <li>{t('residences.features.hvac')}</li>
          <li>{t('residences.features.laundry')}</li>
          <li>{t('residences.features.closets')}</li>
        </ul>
      </div>
    </div>
    <div class="img-txt-gallery">
      <div class="gallery-container-img-txt">
        <div class="gallery-slides">
          <div class="slide active">
            <img
              src="/images/residences/b1-living.webp"
              alt={t('residences.gallery.feature1')}
            />
          </div>
          <div class="slide">
            <img
              src="/images/residences/a1-living.webp"
              alt={t('residences.gallery.feature2')}
            />
          </div>
          <div class="slide">
            <img
              src="/images/residences/a6-living.webp"
              alt={t('residences.gallery.feature3')}
            />
          </div>
        </div>
        <button
          class="gallery-arrow gallery-prev"
          aria-label={t('residences.gallery.prev')}
        >
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path
              d="M15 18L9 12L15 6"
              stroke="white"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"></path>
          </svg>
        </button>

        <button
          class="gallery-arrow gallery-next"
          aria-label={t('residences.gallery.next')}
        >
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path
              d="M9 18L15 12L9 6"
              stroke="white"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"></path>
          </svg>
        </button>

        <div class="gallery-dots">
          <button class="dot active" data-slide="0"></button>
          <button class="dot" data-slide="1"></button>
          <button class="dot" data-slide="2"></button>
        </div>
      </div>
    </div>
  </section>
  <section class="img-txt right">
    <div class="img-txt-content">
      <div class="content-wrapper">
        <h2>{t('residences.kitchen.title')}</h2>
        <ul>
          <li>{t('residences.kitchen.cabinets')}</li>
          <li>{t('residences.kitchen.appliances')}</li>
          <li>{t('residences.kitchen.countertops')}</li>
          <li>{t('residences.kitchen.sink')}</li>
          <li>{t('residences.kitchen.faucet')}</li>
        </ul>
      </div>
    </div>
    <div class="img-txt-image">
      <img
        src="/images/amenities/kitchen.webp"
        alt={t('residences.kitchen.title')}
      />
    </div>
  </section>
  <section class="img-txt left">
    <div class="img-txt-content">
      <div class="content-wrapper">
        <h2>{t('residences.bathroom.title')}</h2>
        <ul>
          <li>{t('residences.bathroom.cabinets')}</li>
          <li>{t('residences.bathroom.countertops')}</li>
          <li>{t('residences.bathroom.sinks')}</li>
          <li>{t('residences.bathroom.floors')}</li>
          <li>{t('residences.bathroom.shower')}</li>
          <li>{t('residences.bathroom.fixtures')}</li>
        </ul>
      </div>
    </div>
    <div class="img-txt-image">
      <img
        src="/images/amenities/bathroom.webp"
        alt={t('residences.bathroom.title')}
      />
    </div>
  </section>
  <section class="full-view-img-text">
    <div class="full-view-image">
      <img
        src="/images/residences/bedroom.webp"
        alt={t('residences.views.title')}
      />
    </div>
    <div class="full-view-text">
      <h2>{t('residences.views.title')}</h2>
    </div>
  </section>
  <section class="zoom-scroll-section" id="zoomSection">
    <div class="zoom-background">
      <img src="/images/residences/view.webp" alt={t('residences.views.alt')} />
    </div>
    <div class="zoom-content">
      <a
        href="https://sftp-bucket-inflightll.s3.amazonaws.com/customer/MENIN%20HOSPITALITY/PALMA/DELIVERABLES/360/DAY/04-05-24/WITH%20MENU/V1/index.html"
        target="_blank"
        class="experience-btn">{t('residences.experience.button')}</a
      >
    </div>
  </section>
  <FloorPlans lang={lang} />
</Layout>

<script>
  class HorizontalGallery {
    constructor() {
      this.track = document.querySelector('.gallery-track');
      this.items = document.querySelectorAll('.gallery-item');
      this.prevBtn = document.querySelector('.gallery-prev');
      this.nextBtn = document.querySelector('.gallery-next');
      this.progressFill = document.querySelector('.progress-fill');

      if (
        !this.track ||
        !this.items.length ||
        !this.prevBtn ||
        !this.nextBtn ||
        !this.progressFill
      ) {
        return;
      }

      this.currentIndex = 0;
      this.itemsToShow = window.innerWidth <= 768 ? 1 : 2;
      this.totalItems = this.items.length;
      this.maxIndex = Math.max(0, this.totalItems - this.itemsToShow);

      this.init();
    }

    init() {
      if (!this.track) return;

      this.updateProgress();
      this.prevBtn.addEventListener('click', () => this.prevSlide());
      this.nextBtn.addEventListener('click', () => this.nextSlide());

      window.addEventListener('resize', () => {
        this.itemsToShow = window.innerWidth <= 768 ? 1 : 2;
        this.maxIndex = Math.max(0, this.totalItems - this.itemsToShow);
        this.currentIndex = Math.min(this.currentIndex, this.maxIndex);
        this.updatePosition();
        this.updateProgress();
      });
    }

    prevSlide() {
      if (!this.track) return;
      if (this.currentIndex === 0) {
        this.currentIndex = this.maxIndex;
      } else {
        this.currentIndex--;
      }
      this.updatePosition();
      this.updateProgress();
    }

    nextSlide() {
      if (!this.track) return;
      if (this.currentIndex >= this.maxIndex) {
        this.currentIndex = 0;
      } else {
        this.currentIndex++;
      }
      this.updatePosition();
      this.updateProgress();
    }

    updatePosition() {
      if (!this.track) return;
      const itemWidth = 100 / this.itemsToShow;
      const translateX = -(this.currentIndex * itemWidth);
      this.track.style.transform = `translateX(${translateX}%)`;
    }

    updateProgress() {
      if (!this.progressFill) return;
      const progress =
        this.maxIndex > 0 ? (this.currentIndex / this.maxIndex) * 100 : 0;
      this.progressFill.style.width = `${progress}%`;
    }
  }

  class ZoomScrollEffect {
    constructor() {
      this.section = document.getElementById('zoomSection');
      if (!this.section) {
        return;
      }

      this.image = this.section.querySelector('.zoom-background img');
      if (!this.image) {
        return;
      }

      this.isInViewport = false;
      this.maxZoom = 1.3;
      this.minZoom = 1;
      this.init();
    }

    init() {
      this.observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            this.isInViewport = entry.isIntersecting;
          });
        },
        {
          threshold: 0.1,
          rootMargin: '50px 0px -50px 0px',
        }
      );

      this.observer.observe(this.section);
      window.addEventListener('scroll', () => this.handleScroll());
    }

    handleScroll() {
      if (!this.isInViewport || !this.image) return;

      const rect = this.section.getBoundingClientRect();
      const windowHeight = window.innerHeight;
      const sectionHeight = rect.height;

      let progress = 0;

      if (rect.top <= windowHeight && rect.bottom >= 0) {
        const visibleHeight =
          Math.min(windowHeight, rect.bottom) - Math.max(0, rect.top);
        const totalScrollableDistance = windowHeight + sectionHeight;
        const scrolledDistance = windowHeight - rect.top;
        progress = Math.max(
          0,
          Math.min(1, scrolledDistance / totalScrollableDistance)
        );
      }

      const zoomLevel = this.minZoom + progress * (this.maxZoom - this.minZoom);
      this.image.style.transform = `scale(${zoomLevel})`;
    }
  }

  class ImgTxtGallery {
    constructor(containerSelector = '.img-txt.has-gallery') {
      this.container = document.querySelector(containerSelector);
      if (!this.container) {
        return;
      }

      this.currentSlide = 0;
      this.slides = this.container.querySelectorAll('.slide');
      this.dots = this.container.querySelectorAll('.dot');
      this.prevBtn = this.container.querySelector('.gallery-prev');
      this.nextBtn = this.container.querySelector('.gallery-next');
      this.isTransitioning = false;

      if (
        !this.slides.length ||
        !this.dots.length ||
        !this.prevBtn ||
        !this.nextBtn
      ) {
        return;
      }

      this.init();
    }

    init() {
      this.prevBtn.addEventListener('click', () => this.prevSlide());
      this.nextBtn.addEventListener('click', () => this.nextSlide());
      this.dots.forEach((dot, index) => {
        dot.addEventListener('click', () => this.goToSlide(index));
      });
      this.startAutoplay();
    }

    prevSlide() {
      if (this.isTransitioning) return;
      const prevIndex =
        this.currentSlide === 0
          ? this.slides.length - 1
          : this.currentSlide - 1;
      this.goToSlide(prevIndex);
    }

    nextSlide() {
      if (this.isTransitioning) return;
      const nextIndex =
        this.currentSlide === this.slides.length - 1
          ? 0
          : this.currentSlide + 1;
      this.goToSlide(nextIndex);
    }

    goToSlide(index) {
      if (this.isTransitioning || index === this.currentSlide) return;
      this.isTransitioning = true;

      this.slides[this.currentSlide].classList.remove('active');
      this.dots[this.currentSlide].classList.remove('active');
      this.slides[this.currentSlide].classList.add('zoom-out');

      setTimeout(() => {
        this.currentSlide = index;
        this.slides[this.currentSlide].classList.add('active', 'zoom-in');
        this.dots[this.currentSlide].classList.add('active');

        setTimeout(() => {
          this.slides.forEach((slide) => {
            slide.classList.remove('zoom-out', 'zoom-in');
          });
          this.isTransitioning = false;
        }, 2000);
      }, 1000);
    }

    startAutoplay() {
      this.autoplayInterval = setInterval(() => {
        if (!this.isTransitioning) {
          this.nextSlide();
        }
      }, 5000);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    try {
      new HorizontalGallery();
    } catch (error) {
      // 
    }
    try {
      new ZoomScrollEffect();
    } catch (error) {
      // 
    }
    try {
      new ImgTxtGallery();
    } catch (error) {
      // 
    }
  });
</script>
